version: '3'
services:
  api:
    build:
      context:  .
      dockerfile: ./Dockerfile
    container_name: hr-graphql-api
    ports:
      - '3000:3000'
    environment:
      APP_ENV: 'local'
      PORT: 3000
      NODE_OPTIONS: '--import ./dist/instrumentation.js'
      DATABASE_URL: 'mysql://root:@db:3306/employees'
      OTEL_EXPORTER_OTLP_ENDPOINT: 'http://jaeger:4318'
    volumes:
      - ./src:/app/src
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_started

  db:
    image: mysql:8
    container_name: mysql-db
    ports:
      - '3306:3306'
      - '33060:33060'
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    volumes:
      - ./test_db/employees.sql:/docker-entrypoint-initdb.d/employees.sql
      - ./test_db/load_departments.dump:/load_departments.dump
      - ./test_db/load_employees.dump:/load_employees.dump
      - ./test_db/load_dept_emp.dump:/load_dept_emp.dump
      - ./test_db/load_dept_manager.dump:/load_dept_manager.dump
      - ./test_db/load_titles.dump:/load_titles.dump
      - ./test_db/load_salaries1.dump:/load_salaries1.dump
      - ./test_db/load_salaries2.dump:/load_salaries2.dump
      - ./test_db/load_salaries3.dump:/load_salaries3.dump
      - ./test_db/show_elapsed.sql:/show_elapsed.sql

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - '16686:16686'  # Jaeger UI
      - '4317:4317'    # OTLP gRPC
      - '4318:4318'    # OTLP HTTP
    environment:
      COLLECTOR_OTLP_ENABLED: 'true'
